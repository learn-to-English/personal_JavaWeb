<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learning.dao.EnrollmentMapper">

    <!-- 结果映射 -->
    <resultMap id="enrollmentMap" type="com.learning.model.Enrollment">
        <id column="id" property="id"/>
        <result column="student_id" property="studentId"/>
        <result column="course_id" property="courseId"/>
        <result column="enroll_time" property="enrollTime"/>
        <result column="course_title" property="courseTitle"/>
        <result column="course_description" property="courseDescription"/>
        <result column="teacher_name" property="teacherName"/>
        <result column="category_name" property="categoryName"/>
        <result column="course_status" property="courseStatus"/>
    </resultMap>

    <!-- 查询学生的所有选课记录（关联查询课程信息，包括已删除/下架的课程） -->
    <select id="findByStudentId" parameterType="int" resultMap="enrollmentMap">
        SELECT
            e.id,
            e.student_id,
            e.course_id,
            e.enroll_time,
            c.title AS course_title,
            c.description AS course_description,
            c.status AS course_status,
            u.username AS teacher_name,
            cat.name AS category_name
        FROM enrollment e
        LEFT JOIN course c ON e.course_id = c.id
        LEFT JOIN user u ON c.teacher_id = u.id
        LEFT JOIN category cat ON c.category_id = cat.id
        WHERE e.student_id = #{studentId}
        ORDER BY e.enroll_time DESC
    </select>

    <!-- 查询学生是否已选某门课 -->
    <select id="findByStudentAndCourse" resultMap="enrollmentMap">
        SELECT * FROM enrollment 
        WHERE student_id = #{studentId} AND course_id = #{courseId}
    </select>

    <!-- 添加选课记录 -->
    <insert id="insert" parameterType="com.learning.model.Enrollment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO enrollment (student_id, course_id, enroll_time)
        VALUES (#{studentId}, #{courseId}, NOW())
    </insert>

    <!-- 删除选课记录 -->
    <delete id="delete" parameterType="int">
        DELETE FROM enrollment WHERE id = #{id}
    </delete>

    <!-- 根据学生ID和课程ID删除 -->
    <delete id="deleteByStudentAndCourse">
        DELETE FROM enrollment
        WHERE student_id = #{studentId} AND course_id = #{courseId}
    </delete>

    <!-- 根据课程ID删除所有选课记录（课程删除时级联删除） -->
    <delete id="deleteByCourseId" parameterType="int">
        DELETE FROM enrollment WHERE course_id = #{courseId}
    </delete>

</mapper>
