<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learning.dao.SubmissionMapper">

    <!-- 结果映射 -->
    <resultMap id="submissionMap" type="com.learning.model.Submission">
        <id column="id" property="id"/>
        <result column="assignment_id" property="assignmentId"/>
        <result column="student_id" property="studentId"/>
        <result column="content" property="content"/>
        <result column="score" property="score"/>
        <result column="feedback" property="feedback"/>
        <result column="status" property="status"/>
        <result column="submit_time" property="submitTime"/>
        <result column="grade_time" property="gradeTime"/>
        <result column="student_name" property="studentName"/>
        <result column="assignment_title" property="assignmentTitle"/>
        <result column="course_name" property="courseName"/>
        <result column="total_score" property="totalScore"/>
        <result column="deadline" property="deadline"/>
    </resultMap>

    <!-- 根据作业ID和学生ID查询提交记录 -->
    <select id="findByAssignmentAndStudent" resultMap="submissionMap">
        SELECT
            s.*,
            u.username AS student_name,
            a.title AS assignment_title,
            a.total_score,
            a.deadline,
            c.title AS course_name
        FROM submission s
                 LEFT JOIN user u ON s.student_id = u.id
                 LEFT JOIN assignment a ON s.assignment_id = a.id
                 LEFT JOIN course c ON a.course_id = c.id
        WHERE s.assignment_id = #{assignmentId} AND s.student_id = #{studentId}
    </select>

    <!-- 根据作业ID查询所有提交记录 -->
    <select id="findByAssignmentId" parameterType="int" resultMap="submissionMap">
        SELECT
            s.*,
            u.username AS student_name
        FROM submission s
                 LEFT JOIN user u ON s.student_id = u.id
        WHERE s.assignment_id = #{assignmentId}
        ORDER BY s.submit_time DESC
    </select>

    <!-- 根据学生ID查询所有提交记录 -->
    <select id="findByStudentId" parameterType="int" resultMap="submissionMap">
        SELECT
            s.*,
            a.title AS assignment_title,
            a.total_score,
            a.deadline,
            c.title AS course_name
        FROM submission s
                 LEFT JOIN assignment a ON s.assignment_id = a.id
                 LEFT JOIN course c ON a.course_id = c.id
        WHERE s.student_id = #{studentId}
        ORDER BY s.submit_time DESC
    </select>

    <!-- 根据ID查询提交详情 -->
    <select id="findById" parameterType="int" resultMap="submissionMap">
        SELECT
            s.*,
            u.username AS student_name,
            a.title AS assignment_title,
            a.total_score,
            a.deadline,
            c.title AS course_name
        FROM submission s
                 LEFT JOIN user u ON s.student_id = u.id
                 LEFT JOIN assignment a ON s.assignment_id = a.id
                 LEFT JOIN course c ON a.course_id = c.id
        WHERE s.id = #{id}
    </select>

    <!-- 添加提交记录 -->
    <insert id="insert" parameterType="com.learning.model.Submission" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO submission (assignment_id, student_id, content, status, submit_time)
        VALUES (#{assignmentId}, #{studentId}, #{content}, 'submitted', NOW())
    </insert>

    <!-- 更新提交记录（用于重新提交）-->
    <update id="update" parameterType="com.learning.model.Submission">
        UPDATE submission
        SET content = #{content},
            score = #{score},
            feedback = #{feedback},
            status = #{status},
            grade_time = #{gradeTime}
        WHERE id = #{id}
    </update>

    <!-- 删除提交记录 -->
    <delete id="delete" parameterType="int">
        DELETE FROM submission WHERE id = #{id}
    </delete>

</mapper>