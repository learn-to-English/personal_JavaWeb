<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.learning.dao.NoticeMapper">

    <resultMap id="noticeMap" type="com.learning.model.Notice">
        <id column="id" property="id"/>
        <result column="type" property="type"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="priority" property="priority"/>
        <result column="course_id" property="courseId"/>
        <result column="publisher_id" property="publisherId"/>
        <result column="publish_time" property="publishTime"/>
        <result column="publisher_name" property="publisherName"/>
        <result column="course_name" property="courseName"/>
        <result column="read_count" property="readCount"/>
        <result column="is_read" property="isRead"/>
    </resultMap>

    <!-- 查询用户的通知 -->
    <select id="findByUser" resultMap="noticeMap">
        SELECT
        n.*,
        u.username AS publisher_name,
        c.title AS course_name,
        (SELECT COUNT(*) FROM notice_read WHERE notice_id = n.id) AS read_count,
        CASE WHEN EXISTS(SELECT 1 FROM notice_read WHERE notice_id = n.id AND user_id = #{userId})
        THEN 1 ELSE 0 END AS is_read
        FROM notice n
        LEFT JOIN user u ON n.publisher_id = u.id
        LEFT JOIN course c ON n.course_id = c.id
        <where>
            <if test="filter == 'unread'">
                NOT EXISTS(SELECT 1 FROM notice_read WHERE notice_id = n.id AND user_id = #{userId})
            </if>
            <if test="filter == 'read'">
                EXISTS(SELECT 1 FROM notice_read WHERE notice_id = n.id AND user_id = #{userId})
            </if>
        </where>
        ORDER BY n.publish_time DESC
    </select>

    <!-- 查询未读通知 -->
    <select id="findUnreadByUser" parameterType="int" resultMap="noticeMap">
        SELECT n.*, u.username AS publisher_name, c.title AS course_name
        FROM notice n
                 LEFT JOIN user u ON n.publisher_id = u.id
                 LEFT JOIN course c ON n.course_id = c.id
        WHERE NOT EXISTS(SELECT 1 FROM notice_read WHERE notice_id = n.id AND user_id = #{userId})
        ORDER BY n.priority DESC, n.publish_time DESC
    </select>

    <!-- 查询教师发布的通知 -->
    <select id="findByPublisher" parameterType="int" resultMap="noticeMap">
        SELECT
            n.*,
            u.username AS publisher_name,
            c.title AS course_name,
            (SELECT COUNT(*) FROM notice_read WHERE notice_id = n.id) AS read_count
        FROM notice n
                 LEFT JOIN user u ON n.publisher_id = u.id
                 LEFT JOIN course c ON n.course_id = c.id
        WHERE n.publisher_id = #{publisherId}
        ORDER BY n.publish_time DESC
    </select>

    <!-- 根据ID查询 -->
    <select id="findById" parameterType="int" resultMap="noticeMap">
        SELECT n.*, u.username AS publisher_name, c.title AS course_name
        FROM notice n
                 LEFT JOIN user u ON n.publisher_id = u.id
                 LEFT JOIN course c ON n.course_id = c.id
        WHERE n.id = #{id}
    </select>

    <!-- 添加通知 -->
    <insert id="insert" parameterType="com.learning.model.Notice" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO notice (type, title, content, priority, course_id, publisher_id, publish_time)
        VALUES (#{type}, #{title}, #{content}, #{priority}, #{courseId}, #{publisherId}, NOW())
    </insert>

    <!-- 更新通知 -->
    <update id="update" parameterType="com.learning.model.Notice">
        UPDATE notice
        SET title = #{title},
            content = #{content},
            priority = #{priority}
        WHERE id = #{id}
    </update>

    <!-- 删除通知 -->
    <delete id="delete" parameterType="int">
        DELETE FROM notice WHERE id = #{id}
    </delete>

    <!-- 统计未读数量 -->
    <select id="countUnread" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM notice n
        WHERE NOT EXISTS(SELECT 1 FROM notice_read WHERE notice_id = n.id AND user_id = #{userId})
    </select>

</mapper>